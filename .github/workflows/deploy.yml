name: Deploy Release to Pages  # Название для workflow: деплой релиза на Pages

# Триггер: когда релиз публикуется (published — после Draft → Publish)
on:
  release:
    types: [published]

jobs:
  deploy:
    # Права: оставляем явные права
    permissions:
      id-token: write   
      contents: read    # чтение репозитория (checkout, теги)
      pages: write      # необходимость для работы с GitHub Pages

    runs-on: ubuntu-latest

    steps:
      - name: Checkout code  # Шаг 1: клонируем репозиторий с полной историей (нужны теги)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get release tag  # Шаг 2: извлекаем имя тега из переменной окружения GITHUB_REF
        id: tag
        run: |
          # GITHUB_REF выглядит как refs/tags/<tag>
          RAW_TAG="${GITHUB_REF#refs/tags/}"
          # Выводим в outputs: шаги позже будут читать steps.tag.outputs.TAG
          echo "TAG=${RAW_TAG}" >> $GITHUB_OUTPUT

      - name: Create version directory and copy files  # Шаг 3: создаём каталог v{tag} и копируем в него сайт
        run: |
          set -euo pipefail
          RAW="${{ steps.tag.outputs.TAG }}"

          # Если тег уже начинается с "v", используем его как есть; иначе добавляем "v" префикс
          if [[ "$RAW" == v* ]]; then
            TAG="$RAW"
          else
            TAG="v$RAW"
          fi

          echo "Using release directory: $TAG"

          # Создаём каталог с версией
          mkdir -p "$TAG"

          # Копируем все файлы и каталоги в $TAG, исключая сам каталог с версией и .git
          shopt -s dotglob
          for file in * .[!.]* ..?*; do
            [ -e "$file" ] || continue
            if [ "$file" = "$TAG" ]; then continue; fi
            if [ "$file" = ".git" ]; then continue; fi
            cp -r "$file" "$TAG/" || true
          done

      - name: (Optional) Configure Pages  # Шаг 4
        uses: actions/configure-pages@v4

      - name: Publish version to gh-pages branch  # Шаг 5: публикуем созданный каталог в ветку gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          # Используем PERSONAL_GITHUB_TOKEN вместо GITHUB_TOKEN
          github_token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          # Публикуем только созданную версию
          publish_dir: ${{ steps.tag.outputs.TAG }}
          publish_branch: gh-pages
