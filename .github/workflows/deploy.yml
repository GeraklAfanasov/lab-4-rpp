name: Deploy Release to Pages

on:
  release:
    types: [published]

jobs:
  deploy:
    permissions:
      id-token: write
      contents: read
      pages: write

    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Клонируем весь репозиторий с историей (нужны теги)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2️⃣ Получаем имя тега из релиза
      - name: Get release tag
        id: tag
        run: |
          RAW_TAG="${GITHUB_REF#refs/tags/}"
          echo "TAG=${RAW_TAG}" >> $GITHUB_OUTPUT

      # 3️⃣ Создаём каталог версии и копируем файлы сайта
      - name: Prepare versioned site directory
        run: |
          set -euo pipefail
          RAW="${{ steps.tag.outputs.TAG }}"
          if [[ "$RAW" == v* ]]; then TAG="$RAW"; else TAG="v$RAW"; fi
          echo "Using release directory: $TAG"

          # Временная директория для деплоя
          mkdir -p deploy_temp/$TAG

          # Копируем файлы сайта в каталог версии
          cp -r index.html en ru deploy_temp/$TAG/

          # Создаём редирект в index.html внутри версии на английскую локализацию
          echo '<meta http-equiv="refresh" content="0; url=en/">' > deploy_temp/$TAG/index.html

          # Обновляем корневой index.html, чтобы редиректить на последнюю версию
          echo '<meta http-equiv="refresh" content="0; url='${TAG}'/">' > deploy_temp/index.html

      # 4️⃣ Настройка GitHub Pages
      - name: Configure Pages
        uses: actions/configure-pages@v4

      # 5️⃣ Публикация на ветку gh-pages
      - name: Publish to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
          publish_dir: deploy_temp
          publish_branch: gh-pages
          keep_files: true  # сохраняем прошлые версии
